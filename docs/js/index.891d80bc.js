(function(t){function e(e){for(var a,r,o=e[0],l=e[1],c=e[2],d=0,h=[];d<o.length;d++)r=o[d],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&h.push(s[r][0]),s[r]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(t[a]=l[a]);u&&u(e);while(h.length)h.shift()();return i.push.apply(i,c||[]),n()}function n(){for(var t,e=0;e<i.length;e++){for(var n=i[e],a=!0,o=1;o<n.length;o++){var l=n[o];0!==s[l]&&(a=!1)}a&&(i.splice(e--,1),t=r(r.s=n[0]))}return t}var a={},s={index:0},i=[];function r(e){if(a[e])return a[e].exports;var n=a[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=a,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(n,a,function(e){return t[e]}.bind(null,a));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/app-demo-unifiedcontrols/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],l=o.push.bind(o);o.push=e,o=o.slice();for(var c=0;c<o.length;c++)e(o[c]);var u=l;i.push([0,"chunk-vendors"]),n()})({0:function(t,e,n){t.exports=n("56d7")},"56d7":function(t,e,n){"use strict";n.r(e);var a=n("2b0e"),s=n("7496"),i=n("40dc"),r=n("8336"),o=n("b0af"),l=n("99d9"),c=n("62ad"),u=n("a523"),d=n("169a"),h=n("ce7e"),p=n("adda"),g=n("f6c4"),f=n("0fd9"),v=n("2db4"),b=n("2fa4"),k=n("8654"),y=function(){var t=this,e=t._self._c;return e(s["a"],[e(i["a"],{attrs:{app:"",color:"primary"}},[e(b["a"]),e(r["a"],{staticClass:"ma-2",attrs:{raised:"",disabled:t.htmlBool(t.token)},on:{click:function(e){t.showLoginPartnerDialog=!0}}},[t._v("Sign in with partner key")]),e(r["a"],{staticClass:"ma-2",attrs:{raised:"",disabled:t.htmlBool(t.token)},on:{click:t.signInWithAccount}},[t._v("Sign in with Olisto account")]),e(r["a"],{staticClass:"ma-2",attrs:{raised:"",disabled:!t.htmlBool(t.token)},on:{click:t.signout}},[t._v("Sign out")]),e(r["a"],{staticClass:"ma-2",attrs:{raised:"",disabled:!t.htmlBool(t.token)},on:{click:function(e){t.showDeleteAccountDialog=!0}}},[t._v("Delete user context")])],1),e(g["a"],[t.units.length?e(u["a"],{attrs:{fluid:""}},[e("p",[t._v("Control a device")]),e(f["a"],{attrs:{dense:""}},t._l(t.units,(function(n,a){return e(c["a"],{key:a},[e(o["a"],{attrs:{width:"400"}},[e(l["c"],[t._v(t._s(n.name))]),e(l["b"],[t._l(t.unitTypesMap[n.typeKey].allTraits,(function(a,s){return[e(h["a"],{key:"divider-"+s}),t.$options.components[a+"Control"]?e(a+"Control",{key:"controller-"+s,tag:"component",staticClass:"my-4",attrs:{unit:n,attributes:(t.unitTypesMap[n.typeKey].attributes||{})[a]||{},socketReady:t.socketReady,requestAction:t.requestAction}}):e("p",{key:s},[t._v(t._s(a))])]}))],2)],1)],1)})),1)],1):t._e(),t.channels.length?e(u["a"],{attrs:{fluid:""}},[e("p",[t._v(t._s(t.units.length?"Or, c":"C")+"onnect to a channel")]),e(f["a"],{attrs:{dense:""}},t._l(t.channels,(function(n,a){return e(c["a"],{key:a,staticClass:"mx-auto"},[e(o["a"],{attrs:{"max-width":"300"}},[e(p["a"],{staticClass:"white--text align-end",attrs:{height:"200px",src:`${t.server}/api/v1/files/${n.channelInfo.images.header}?width=300`,gradient:"to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)"}},[e(l["c"],[t._v(t._s(t.ts(n.channelInfo.title)))])],1),e(l["b"]),e(l["a"],{staticClass:"justify-end"},[t.connectedChannelsMap[n.id]?e(r["a"],{on:{click:function(e){return t.disconnectChannel(n)}}},[t._v("Disconnect")]):e(r["a"],{attrs:{href:`${t.server}/api/v1/accessControl/proxy/channel/${n.id}/ops/signin?externalCallbackUrl=${encodeURIComponent(t.thisUrl())}&bearerToken=${t.token}`,target:"_self"}},[t._v("Connect")])],1)],1)],1)})),1)],1):t._e()],1),e(d["a"],{model:{value:t.showLoginPartnerDialog,callback:function(e){t.showLoginPartnerDialog=e},expression:"showLoginPartnerDialog"}},[e(o["a"],[e(l["c"],[t._v("Log in using partner key")]),e(l["b"],[e(k["a"],{attrs:{label:"Partner key",autofocus:"",required:""},model:{value:t.partnerKey,callback:function(e){t.partnerKey=e},expression:"partnerKey"}}),e(k["a"],{attrs:{label:"User ID",required:""},model:{value:t.partnerUserId,callback:function(e){t.partnerUserId=e},expression:"partnerUserId"}})],1),e(l["a"],{staticClass:"justify-end"},[e(r["a"],{attrs:{color:"blue darken-1",text:""},on:{click:function(e){t.signInWithPartnerKey(),t.showLoginPartnerDialog=!1}}},[t._v("Log in")]),e(r["a"],{attrs:{color:"blue darken-1",text:""},on:{click:function(e){t.showLoginPartnerDialog=!1}}},[t._v("Nevermind")])],1)],1)],1),e(d["a"],{model:{value:t.showDeleteAccountDialog,callback:function(e){t.showDeleteAccountDialog=e},expression:"showDeleteAccountDialog"}},[e(o["a"],[e(l["c"],[t._v("Delete user context")]),e(l["b"],[e("h2",[t._v("Beware!")]),e("p",[t._v("This actually deletes the current user context (account), even if it's a regular Olisto account, and can not be undone! Are you sure?")])]),e(l["a"],{staticClass:"justify-end"},[e(r["a"],{attrs:{color:"red",text:""},on:{click:function(e){t.deleteAccount(),t.showDeleteAccountDialog=!1}}},[t._v("Accept")]),e(r["a"],{attrs:{color:"blue darken-1",text:""},on:{click:function(e){t.showDeleteAccountDialog=!1}}},[t._v("Cancel")])],1)],1)],1),e(v["a"],{attrs:{color:"red"},model:{value:t.showingError,callback:function(e){t.showingError=e},expression:"showingError"}},[t._v(t._s(t.errorText))])],1)},m=[],w=n("bc3a"),S=n.n(w),_=n("b73d"),C=function(){var t=this,e=t._self._c;return e("div",[e(_["a"],{attrs:{label:"OnOff",value:t.value,disabled:t.attributes.isSenseOnly||t.loading,loading:t.loading,"hide-details":""},on:{change:t.changeValue}})],1)},O=[],U={name:"OnOffControl",props:["unit","attributes","socketReady","requestAction"],data:()=>({value:!1,loading:!1}),watch:{socketReady:{immediate:!0,handler(t){t&&!this.attributes.isSetOnly&&this.$socket.client.emit("subscribe",{states:[this.unit.endpoint+".CurrentOnOffState"]})}}},sockets:{stateUpdate(t){const e=t[this.unit.endpoint];e&&e.CurrentOnOffState&&("on"===e.CurrentOnOffState?this.value=!0:"off"===e.CurrentOnOffState&&(this.value=!1))}},async created(){const t=(await S.a.get(`/api/v1/state/${this.unit.endpoint}/CurrentOnOffState`)).data;this.value="on"===t},methods:{changeValue(t){this.loading=!0,this.requestAction({action:"setOnOff",endpoints:[this.unit.endpoint],args:{targetOnOffState:t?"on":"off"}}).finally(()=>{this.loading=!1})}}},T=U,x=n("2877"),$=Object(x["a"])(T,C,O,!1,null,null,null),j=$.exports,D=n("ba0d"),A=function(){var t=this,e=t._self._c;return e("div",[e(D["a"],{attrs:{min:"0",max:"100",unit:"%",label:"Brightness",value:t.value,disabled:t.attributes.isSenseOnly||t.loading,loading:t.loading,"hide-details":""},on:{change:t.changeValue}})],1)},M=[],I={name:"BrightnessControl",props:["unit","attributes","socketReady","requestAction"],data:()=>({value:50,loading:!1}),watch:{socketReady:{immediate:!0,handler(t){t&&!this.attributes.isSetOnly&&this.$socket.client.emit("subscribe",{states:[this.unit.endpoint+".CurrentBrightness"]})}}},sockets:{stateUpdate(t){const e=t[this.unit.endpoint];e&&e.CurrentBrightness&&null!=e.CurrentBrightness&&!isNaN(Number(e.CurrentBrightness))&&(this.value=Number(e.CurrentBrightness))}},async created(){const t=(await S.a.get(`/api/v1/state/${this.unit.endpoint}/CurrentBrightness`)).data;isNaN(Number(t))||(this.value=Number(t))},methods:{changeValue(t){this.loading=!0,this.requestAction({action:"setBrightness",endpoints:[this.unit.endpoint],args:{targetBrightness:Math.round(t)}}).finally(()=>{this.loading=!1})}}},L=I,B=Object(x["a"])(L,A,M,!1,null,null,null),P=B.exports,K=n("cc20"),q=n("ef9a"),R=n("132d"),E=n("24c9"),N=function(){var t=this,e=t._self._c;return e("div",[t.attributes.isSetOnly?t._e():e("div",[e(E["a"],[t._v("Lock current state")]),e(q["a"],t._l(t.possibleCurrentStates,(function(n){return e(K["a"],{key:n,attrs:{outlined:""}},[t.currentState===n?e(R["a"],{attrs:{left:"",color:"green"}},[t._v(" mdi-check ")]):t._e(),t._v(" "+t._s(n)+" ")],1)})),1)],1),t.attributes.isSenseOnly?t._e():e("div",[e(E["a"],[t._v("Set lock to:")]),e("div",t._l(t.possibleTargetStates,(function(n){return e(r["a"],{key:n,staticClass:"mr-4",attrs:{loading:t.loading,disabled:t.loading},on:{click:function(e){return t.setState(n)}}},[t._v(t._s(n))])})),1)],1)])},W=[],V=(n("14d9"),{name:"LockControl",props:["unit","attributes","socketReady","requestAction"],data:()=>({currentState:"unknown",targetState:null,possibleCurrentStates:["unknown","locked"],possibleTargetStates:["locked"],loading:!1}),watch:{socketReady:{immediate:!0,handler(t){console.log("have lock",this.unit,this.attributes),t&&!this.attributes.isSetOnly&&this.$socket.client.emit("subscribe",{states:[this.unit.endpoint+".CurrentLockState"]})}}},sockets:{stateUpdate(t){var e,n;null!==(e=t[this.unit.endpoint])&&void 0!==e&&e.CurrentLockState&&(this.currentState=null===(n=t[this.unit.endpoint])||void 0===n?void 0:n.CurrentLockState)}},async created(){this.attributes.isSetOnly||(this.currentState=(await S.a.get(`/api/v1/state/${this.unit.endpoint}/CurrentLockState`)).data||"unknown"),this.possibleCurrentStates.push("unlocked"),this.possibleTargetStates.push("unlocked"),this.attributes.hasOpen&&(this.possibleCurrentStates.push("open"),this.possibleTargetStates.push("open")),this.attributes.hasTimedOpen&&this.possibleTargetStates.push("timedOpen"),this.attributes.hasTimedUnlock&&this.possibleTargetStates.push("timedUnlock"),this.attributes.hasJammed&&this.possibleCurrentStates.push("jammed")},methods:{setState(t){this.loading=!0,this.requestAction({action:"setLockState",endpoints:[this.unit.endpoint],args:{targetLockState:t}}).finally(()=>{this.loading=!1})}}}),J=V,z=Object(x["a"])(J,N,W,!1,null,null,null),F=z.exports,G=function(){var t=this,e=t._self._c;return e("div",[e(E["a"],[t._v("Contact sensor state")]),e(q["a"],t._l(t.possibleCurrentStates,(function(n){return e(K["a"],{key:n,attrs:{outlined:""}},[t.currentState===n?e(R["a"],{attrs:{left:"",color:"green"}},[t._v(" mdi-check ")]):t._e(),t._v(" "+t._s(n)+" ")],1)})),1)],1)},H=[],Q={name:"ContactSensorControl",props:["unit","attributes","socketReady"],data:()=>({currentState:"unknown",possibleCurrentStates:["unknown","open","closed"]}),watch:{socketReady:{immediate:!0,handler(t){console.log("have ContactSensor",this.unit,this.attributes),t&&this.$socket.client.emit("subscribe",{states:[this.unit.endpoint+".ContactSensorState"]})}}},sockets:{stateUpdate(t){var e,n;null!==(e=t[this.unit.endpoint])&&void 0!==e&&e.ContactSensorState&&(this.currentState=null===(n=t[this.unit.endpoint])||void 0===n?void 0:n.ContactSensorState)}},async created(){this.currentState=(await S.a.get(`/api/v1/state/${this.unit.endpoint}/ContactSensorState`)).data||"unknown"}},X=Q,Y=Object(x["a"])(X,G,H,!1,null,null,null),Z=Y.exports;const tt={OnOff:j,Brightness:P,Lock:F,ContactSensor:Z};var et={name:"App",components:{...Object.fromEntries(Object.keys(tt).map(t=>[t+"Control",tt[t]]))},data:()=>({channels:[],channelsMap:{},unitTypesMap:{},connectedChannelsMap:{},units:[],token:null,partnerKey:null,partnerUserId:null,showLoginPartnerDialog:!1,showDeleteAccountDialog:!1,errorText:"",showingError:!1,server:window.server,socketReady:!1}),watch:{async token(t){t?(S.a.defaults.headers.authorization="Bearer "+t,window.localStorage.token=t,this.$socket.client.isConnected||this.$socket.client.open()):(window.localStorage.removeItem("token"),delete S.a.defaults.headers.authorization,this.$socket.client.disconnect()),await this.loadUnitTypes(),this.updateUnits()},partnerKey(t){window.localStorage.partnerKey=t},partnerUserId(t){window.localStorage.partnerUserId=t}},sockets:{connect(){this.$socket.client.emit("authenticate",{bearerToken:this.token,client:"unified-controls-demo-app"}),this.socketReady=!0},disconnect(){this.socketConnected=!1},error(t){console.log("socket errored",t),this.socketConnected=!1},event(t){console.log("have event",t),t.name.startsWith("unit-")&&this.triggerUpdateUnits()}},async created(){if(S.a.defaults.baseURL=this.server,this.partnerKey=window.localStorage.partnerKey||"",this.partnerUserId=window.localStorage.partnerUserId||"",this.$route.query.token){this.token=this.$route.query.token;const t={...this.$route.query};delete t.token,this.$router.replace({query:t})}else window.localStorage.token&&(this.token=window.localStorage.token)},methods:{showError(t){this.showingError=this.errorText=t},htmlBool(t){return!!t||null},thisUrl(){return document.location},ts:function(t){return"string"===typeof t?t:t.en},async loadUnitTypes(){if(!this.token)return this.unitTypesMap={},this.channelsMap={},void(this.channels=[]);const t=(await S.a.get("/api/v1/channels/descriptions")).data,e=Object.values(t).map(t=>t.unitTypes.map(e=>({channel:t.id,...e}))).flat().filter(t=>t.allTraits&&t.allTraits.some(t=>tt[t]));this.unitTypesMap=Object.fromEntries(e.map(t=>[`${t.channel}.${t.id}`,t])),this.channelsMap=Object.fromEntries(e.map(e=>[e.channel,t[e.channel]])),this.channels=Object.values(this.channelsMap)},triggerUpdateUnits(){this.triggerUpdateUnitsTimer&&clearTimeout(this.triggerUpdateUnitsTimer),this.triggerUpdateUnitsTimer=setTimeout(()=>{this.triggerUpdateUnitsTimer=null,this.updateUnits()},1e3)},async updateUnits(){if(!this.token)return void(this.units=[]);const t=(await S.a.get("/api/v1/channelaccounts?status=connected")).data;this.connectedChannelsMap=Object.fromEntries(t.map(t=>[t.channel,t]));const e=(await S.a.get("/api/v1/units")).data;this.units=e.map(t=>{const e=`${t.channel}.${t.type}`;return this.unitTypesMap[e]?{...t,typeKey:e}:null}).filter(t=>t)},signout(){this.token="",this.unitTypesMap={},this.channelsMap={},this.channels=[],this.units=[]},signInWithAccount(){this.signout(),document.location=`${this.server}/api/v1/usersession/oauth2/signin.html?response_type=token&client_id=olisto-demo&redirect_uri=${encodeURIComponent(document.location)}`},async signInWithPartnerKey(){this.signout();try{const t=await S.a.post("/api/v1/users/account",{partnerKey:this.partnerKey,partnerUserId:this.partnerUserId});this.token=t.data.token}catch(t){this.showError(t.response.data.error||"Login error")}},async deleteAccount(){await S.a.delete("/api/v1/users/"),this.signout()},async disconnectChannel(t){await S.a.delete("/api/v1/channelaccounts/"+this.connectedChannelsMap[t.id]._id),this.updateUnits()},async requestAction(t){return await S.a.post("/api/v1/actions",t).then(t=>{this.showingError=this.errorText=t.data,"olisto/ok"!==t.data&&console.warn("result not OK: "+t.data)})}}},nt=et,at=Object(x["a"])(nt,y,m,!1,null,null,null),st=at.exports,it=n("f309");a["a"].use(it["a"]);var rt=new it["a"]({}),ot=n("f87c"),lt=n("8c4f"),ct=n("daa8");a["a"].config.productionTip=!1,a["a"].use(ot["a"],Object(ct["a"])(window.server,{autoConnect:!1,transports:["polling","websocket"]})),a["a"].use(lt["a"]);const ut=[],dt=new lt["a"]({routes:ut});new a["a"]({vuetify:rt,router:dt,render:t=>t(st)}).$mount("#app")}});
//# sourceMappingURL=index.891d80bc.js.map